{# Administration des produits : liste, création, modification et suppression des articles #}
{% extends 'base.html.twig' %}

{% block title %}Gestion des Produits - Admin
{% endblock %}

{% block body %}
	<div class="container" style="margin-top: 2rem;">
		<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
			<h1 style="font-size: 2.5rem; color: var(--color-primary);">Gestion des Produits</h1>
			<div style="display: flex; gap: 1rem;">
				<a href="{{ path('app_admin_product_new') }}" class="btn btn-primary">Ajouter un produit</a>
				<a href="{{ path('app_admin_dashboard') }}" class="btn btn-secondary">Dashboard</a>
			</div>
		</div>

		<div style="background-color: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 2rem;">
			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
				<h2 style="font-size: 1.5rem; color: var(--color-primary); margin: 0;">Liste des produits ({{ products|length }})</h2>

				{# Formulaires de filtres #}
				<div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
					<form
						method="get" action="{{ path('app_admin_products') }}" style="display: flex; gap: 0.5rem; align-items: center;">
						{# Conserver le filtre stock si actif #}
						{% if selectedStockFilter %}
							<input type="hidden" name="stock" value="{{ selectedStockFilter }}">
						{% endif %}
						<label for="category" style="font-weight: 500; color: var(--color-text);">Catégorie:</label>
						<select name="category" id="category" onchange="this.form.submit()" style="padding: 0.5rem 1rem; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 1rem; background-color: white; color: var(--color-text); cursor: pointer;">
							<option value="">Toutes</option>
							{% for category in categories %}
								<option value="{{ category }}" {% if selectedCategory == category %} selected {% endif %}>
									{{ category }}
								</option>
							{% endfor %}
						</select>
					</form>

					<form
						method="get" action="{{ path('app_admin_products') }}" style="display: flex; gap: 0.5rem; align-items: center;">
						{# Conserver le filtre catégorie si actif #}
						{% if selectedCategory %}
							<input type="hidden" name="category" value="{{ selectedCategory }}">
						{% endif %}
						<label for="stock" style="font-weight: 500; color: var(--color-text);">Stock:</label>
						<select name="stock" id="stock" onchange="this.form.submit()" style="padding: 0.5rem 1rem; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 1rem; background-color: white; color: var(--color-text); cursor: pointer;">
							<option value="">Tous</option>
							<option value="low" {% if selectedStockFilter == 'low' %} selected {% endif %}>Stock faible (&lt; 10)</option>
							<option value="medium" {% if selectedStockFilter == 'medium' %} selected {% endif %}>Stock moyen (10-30)</option>
							<option value="high" {% if selectedStockFilter == 'high' %} selected {% endif %}>Stock élevé (&gt; 30)</option>
							<option value="out" {% if selectedStockFilter == 'out' %} selected {% endif %}>En rupture</option>
						</select>
					</form>

					{% if selectedCategory or selectedStockFilter %}
						<a href="{{ path('app_admin_products') }}" style="padding: 0.5rem 1rem; background-color: #f0f0f0; color: var(--color-text); text-decoration: none; border-radius: 4px; font-size: 0.9rem;">Effacer tous</a>
					{% endif %}
				</div>
			</div>

			{% if products|length > 0 %}
				<div style="overflow-x: auto;">
					<table style="width: 100%; border-collapse: collapse;">
						<thead>
							<tr style="border-bottom: 2px solid #e0e0e0;">
								<th style="padding: 1rem; text-align: left; color: var(--color-text);">Vedette</th>
								<th style="padding: 1rem; text-align: left; color: var(--color-text);">Image</th>
								<th style="padding: 1rem; text-align: left; color: var(--color-text);">ID</th>
								<th style="padding: 1rem; text-align: left; color: var(--color-text);">Nom</th>
								<th style="padding: 1rem; text-align: left; color: var(--color-text);">Catégorie</th>
								<th style="padding: 1rem; text-align: left; color: var(--color-text);">Prix</th>
								<th style="padding: 1rem; text-align: left; color: var(--color-text);">Stock</th>
								<th style="padding: 1rem; text-align: left; color: var(--color-text);">Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for product in products %}
								<tr style="border-bottom: 1px solid #e0e0e0;" data-controller="featured-toggle">
									<td style="padding: 1rem; text-align: center;">
										<form method="post" action="{{ path('app_admin_product_toggle_featured', {'id': product.id}) }}" style="margin: 0;" data-action="submit->featured-toggle#toggle">
											<button type="submit" style="background: none; border: none; cursor: pointer; padding: 0; outline: none;">
												<i class="fa{% if product.isFeatured %}s{% else %}r{% endif %} fa-star" style="color: {% if product.isFeatured %}#fbc02d{% else %}#ccc{% endif %}; font-size: 1.25rem;" title="{% if product.isFeatured %}Retirer des vedettes{% else %}Mettre en vedette{% endif %}"></i>
											</button>
										</form>
									</td>
									<td style="padding: 1rem;">
										{% if product.imageName %}
											<img src="{{ asset('uploads/products/' ~ product.imageName) }}" alt="{{ product.name }}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
										{% else %}
											<div style="width: 50px; height: 50px; background: #f0f0f0; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
												<i class="fas fa-image" style="color: #ccc;"></i>
											</div>
										{% endif %}
									</td>
									<td style="padding: 1rem;">#{{ product.id }}</td>
									<td style="padding: 1rem;">
										<strong>{{ product.name }}</strong>
										{% if product.description %}
											<br><small style="color: var(--color-text-light);">{{ product.description|slice(0, 50) }}...</small>
										{% endif %}
									</td>
									<td style="padding: 1rem;">{{ product.category }}</td>
									<td style="padding: 1rem; font-weight: bold; color: var(--color-primary);">{{ product.price }}
										€</td>
									<td style="padding: 1rem;">
										<span style="padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.85rem;
																																				                                            {% if product.stock < 10 %}
																																				                                                background-color: #fee2e2; color: #dc2626;
																																				                                            {% elseif product.stock < 30 %}
																																				                                                background-color: #fef3c7; color: #d97706;
																																				                                            {% else %}
																																				                                                background-color: #d1fae5; color: #059669;
																																				                                            {% endif %}">
											{{ product.stock ?? 'N/A' }}
										</span>
									</td>
									<td style="padding: 1rem;">
										<div style="display: flex; gap: 0.5rem; align-items: center;">
											<a href="{{ path('app_admin_product_edit', {'id': product.id}) }}" class="btn btn-small" style="background-color: var(--color-accent); color: white; display: inline-block; z-index: 1; position: relative; text-decoration: none;">Modifier</a>
											<form method="post" action="{{ path('app_admin_product_delete', {'id': product.id}) }}" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce produit ?');" style="display: inline-block; margin: 0;">
												<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ product.id) }}">
												<button type="submit" class="btn btn-small btn-danger" style="display: inline-block; z-index: 1; position: relative;">Supprimer</button>
											</form>
										</div>
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			{% else %}
				<p style="color: var(--color-text-light); text-align: center; padding: 2rem;">Aucun produit</p>
			{% endif %}
		</div>
	</div>
{% endblock %}
