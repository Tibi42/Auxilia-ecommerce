{% extends 'base.html.twig' %}

{% block title %}Modifier le produit - Admin
{% endblock %}

{% block body %}
<div class="container admin-container" style="margin-top: 3rem; margin-bottom: 5rem;">
	<div class="admin-header" style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 3rem;">
		<div>
			<nav aria-label="breadcrumb">
				<ol style="list-style: none; padding: 0; display: flex; gap: 0.5rem; font-size: 0.9rem; margin-bottom: 0.5rem;">
					<li>
						<a href="{{ path('app_admin_products') }}" style="color: var(--color-primary); text-decoration: none;">Produits</a>
					</li>
					<li style="color: var(--color-text-light);">/</li>
					<li style="color: var(--color-text-light);">Édition</li>
				</ol>
			</nav>
			<h1 style="font-size: 2.8rem; font-weight: 800; color: var(--color-dark); margin: 0; letter-spacing: -1px;">
				Modifier le
				<span style="color: var(--color-primary);">produit</span>
			</h1>
		</div>
		<a href="{{ path('app_admin_products') }}" class="btn btn-secondary" style="border-radius: 12px; padding: 0.8rem 1.5rem; display: flex; align-items: center; gap: 0.5rem; background: #f0f0f0; color: #333; border: 1px solid #ddd;">
			<i class="fas fa-arrow-left"></i>
			Retour
		</a>
	</div>

	<div style="background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.05); padding: 3rem; position: relative; overflow: hidden;">
		<div style="position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: linear-gradient(90deg, var(--color-primary), var(--color-accent));"></div>

		{{ form_start(form) }}
		<div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 4rem;">
			<div class="form-sections">
				<section style="margin-bottom: 2.5rem;">
					<h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
						<div style="width: 32px; height: 32px; background: rgba(37, 99, 235, 0.1); color: var(--color-primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem;">1</div>
						Informations générales
					</h3>
					<div style="display: flex; flex-direction: column; gap: 1.5rem;">
						<div class="custom-form-row">
							{{ form_label(form.name) }}
							{{ form_widget(form.name, {'attr': {'style': 'border-radius: 12px; border: 2px solid #edf2f7; padding: 1rem; width: 100%; transition: all 0.3s; font-size: 1rem;'}}) }}
						</div>
						<div class="custom-form-row">
							{{ form_label(form.category) }}
							{{ form_widget(form.category, {'attr': {'style': 'border-radius: 12px; border: 2px solid #edf2f7; padding: 1rem; width: 100%; transition: all 0.3s; font-size: 1rem;'}}) }}
						</div>
						<div class="custom-form-row">
							{{ form_label(form.description) }}
							{{ form_widget(form.description, {'attr': {'style': 'border-radius: 12px; border: 2px solid #edf2f7; padding: 1rem; width: 100%; transition: all 0.3s; font-size: 1rem; min-height: 150px;'}}) }}
						</div>
					</div>
				</section>

				<section>
					<h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
						<div style="width: 32px; height: 32px; background: rgba(37, 99, 235, 0.1); color: var(--color-primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem;">2</div>
						Prix et Stock
					</h3>
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start;">
						<div class="custom-form-row">
							{{ form_label(form.price) }}
							<div style="position: relative;">
								{{ form_widget(form.price, {'attr': {'style': 'border-radius: 12px; border: 2px solid #edf2f7; padding: 1rem; width: 100%; transition: all 0.3s; font-size: 1rem;'}}) }}
							</div>
						</div>
						<div class="custom-form-row">
							{{ form_label(form.stock) }}
							<div style="position: relative;">
								{{ form_widget(form.stock, {'attr': {'style': 'border-radius: 12px; border: 2px solid #edf2f7; padding: 1rem; width: 100%; transition: all 0.3s; font-size: 1rem;'}}) }}
							</div>
						</div>
					</div>
				</section>
			</div>

			<div class="image-upload-section">
				<section style="background: #f8fafc; border-radius: 20px; padding: 2rem; height: 100%;">
					<h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
						<i class="fas fa-image" style="color: var(--color-primary);"></i>
						Image du produit
					</h3>

					<div id="image-preview-container" class="drag-drop-zone" style="margin-bottom: 2rem; position: relative; aspect-ratio: 1; border-radius: 16px; overflow: hidden; border: 2px dashed #cbd5e0; display: flex; align-items: center; justify-content: center; background: white; cursor: pointer; transition: all 0.3s ease;">
						{% if product.imageName %}
							<img id="current-image" src="{{ asset('uploads/products/' ~ product.imageName) }}" alt="{{ product.name }}" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;">
						{% else %}
							<div id="image-placeholder" style="text-align: center; color: #a0aec0; pointer-events: none;">
								<i class="fas fa-cloud-upload-alt" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
								<p style="font-size: 0.9rem; margin-bottom: 0.5rem;">Glissez-déposez une image ici</p>
								<p style="font-size: 0.75rem; opacity: 0.7;">ou cliquez pour parcourir</p>
							</div>
						{% endif %}
						<img id="image-preview" src="" alt="Nouvel aperçu" style="display: none; width: 100%; height: 100%; object-fit: cover; pointer-events: none;">
						<div id="preview-label" style="display: none; position: absolute; bottom: 0; left: 0; right: 0; background: rgba(37, 99, 235, 0.8); backdrop-filter: blur(4px); color: white; padding: 0.75rem; text-align: center; font-size: 0.8rem; pointer-events: none;">
							Nouvel aperçu
						</div>
						{% if product.imageName %}
						<div id="current-label" style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); color: white; padding: 0.75rem; text-align: center; font-size: 0.8rem; pointer-events: none;">
							Aperçu actuel
						</div>
						{% endif %}
					</div>

					<div class="upload-control">
						{{ form_label(form.image, 'Changer l\'image', {'label_attr': {'style': 'font-weight: 600; color: var(--color-dark); margin-bottom: 0.5rem; display: block;'}}) }}
                                <div class="file-input-wrapper">
                                    {{ form_widget(form.image, {'attr': {'class': 'custom-file-input', 'id': 'product-image-input', 'accept': 'image/jpeg,image/png,image/webp'}}) }}
                                </div>
                                <p style="font-size: 0.8rem; color: #718096; margin-top: 0.5rem;">
                                    Format recommandé : 1000x1000px, PNG ou JPG.
                                </p>
                            </div>
                        </section>
                    </div>
                </div>

                <div style="margin-top: 4rem; padding-top: 2rem; border-top: 1px solid #edf2f7; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" class="btn" style="background: var(--color-primary); color: white; padding: 1rem 2.5rem; border-radius: 14px; font-weight: 600; font-size: 1.1rem; box-shadow: 0 10px 15px rgba(37, 99, 235, 0.2); transition: all 0.3s; display: flex; align-items: center; gap: 0.75rem;">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                    </div>
                </div>
            {{ form_end(form) }}

            {# Hidden delete form attached to the button below for spacing #}
            <div style="position: absolute; bottom: 3rem; right: 3rem;">
                <form method="post" action="{{ path('app_admin_product_delete', {'id': product.id}) }}" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce produit ?');">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ product.id) }}">
                    <button class="btn" style="background: transparent; color: #e53e3e; font-size: 0.9rem; font-weight: 600; border: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-trash-alt"></i> Supprimer définitivement
                    </button>
                </form>
            </div>
        </div>
    </div>

    <style>
        .custom-form-row {
            display: flex;
            flex-direction: column;
        }
        
        .custom-form-row label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            height: auto;
        }
        
        input:focus, textarea:focus {
            border-color: var(--color-primary) !important;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1) !important;
            outline: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        .admin-container {
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .drag-drop-zone.drag-over {
            border-color: var(--color-primary) !important;
            background: rgba(37, 99, 235, 0.05) !important;
            transform: scale(1.02);
        }

        .drag-drop-zone:hover {
            border-color: var(--color-primary);
            background: rgba(37, 99, 235, 0.02);
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Trouver le champ input file (par ID ou par type)
            const imageInput = document.getElementById('product-image-input') || 
                               document.querySelector('input[type="file"][name*="image"]');
            const imagePreview = document.getElementById('image-preview');
            const imagePlaceholder = document.getElementById('image-placeholder');
            const currentImage = document.getElementById('current-image');
            const currentLabel = document.getElementById('current-label');
            const previewLabel = document.getElementById('preview-label');
            const imageContainer = document.getElementById('image-preview-container');

            // Fonction pour traiter un fichier image
            function handleImageFile(file) {
                if (!file) return false;

                // Vérifier que c'est une image
                const validImageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
                if (!validImageTypes.includes(file.type) && !file.type.startsWith('image/')) {
                    alert('Veuillez sélectionner un fichier image valide (JPG, PNG, WEBP).');
                    return false;
                }

                // Mettre à jour le champ input file avec DataTransfer
                // DataTransfer est supporté dans tous les navigateurs modernes
                try {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    imageInput.files = dataTransfer.files;
                    
                    // Déclencher l'événement change pour s'assurer que le formulaire détecte le changement
                    const changeEvent = new Event('change', { bubbles: true });
                    imageInput.dispatchEvent(changeEvent);
                } catch (e) {
                    console.warn('DataTransfer non supporté, le fichier sera prévisualisé mais devra être sélectionné via le bouton Parcourir');
                }

                // Créer un FileReader pour lire le fichier
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // Afficher l'image prévisualisée
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    if (previewLabel) {
                        previewLabel.style.display = 'block';
                    }
                    
                    // Masquer l'image actuelle et son label si elle existe
                    if (currentImage) {
                        currentImage.style.display = 'none';
                    }
                    if (currentLabel) {
                        currentLabel.style.display = 'none';
                    }
                    if (imagePlaceholder) {
                        imagePlaceholder.style.display = 'none';
                    }
                    
                    imageContainer.style.border = '2px solid var(--color-primary)';
                    imageContainer.classList.remove('drag-over');
                };
                
                reader.onerror = function() {
                    alert('Erreur lors de la lecture du fichier.');
                    imageInput.value = '';
                };
                
                reader.readAsDataURL(file);
                return true;
            }

            if (imageInput && imagePreview && imageContainer) {
                // Gestion du changement de fichier via input
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        handleImageFile(file);
                    } else {
                        // Si aucun fichier n'est sélectionné, réinitialiser
                        imagePreview.style.display = 'none';
                        if (previewLabel) {
                            previewLabel.style.display = 'none';
                        }
                        
                        // Réafficher l'image actuelle ou le placeholder
                        if (currentImage) {
                            currentImage.style.display = 'block';
                        }
                        if (currentLabel) {
                            currentLabel.style.display = 'block';
                        }
                        if (imagePlaceholder) {
                            imagePlaceholder.style.display = 'block';
                        }
                        
                        imageContainer.style.border = '2px dashed #cbd5e0';
                    }
                });

                // Gestion du drag and drop
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    imageContainer.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                // Ajouter la classe drag-over quand on survole avec un fichier
                ['dragenter', 'dragover'].forEach(eventName => {
                    imageContainer.addEventListener(eventName, function() {
                        imageContainer.classList.add('drag-over');
                    }, false);
                });

                // Retirer la classe drag-over quand on quitte la zone
                ['dragleave', 'drop'].forEach(eventName => {
                    imageContainer.addEventListener(eventName, function() {
                        imageContainer.classList.remove('drag-over');
                    }, false);
                });

                // Gérer le drop
                imageContainer.addEventListener('drop', function(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    if (files && files.length > 0) {
                        handleImageFile(files[0]);
                    } else {
                        // Gérer les items si files n'est pas disponible
                        const items = dt.items;
                        if (items && items.length > 0) {
                            for (let i = 0; i < items.length; i++) {
                                if (items[i].kind === 'file') {
                                    const file = items[i].getAsFile();
                                    if (file) {
                                        handleImageFile(file);
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }, false);

                // Permettre de cliquer sur la zone pour ouvrir le sélecteur de fichier
                imageContainer.addEventListener('click', function(e) {
                    // Ne pas déclencher si on clique sur l'image prévisualisée ou actuelle
                    if (e.target !== imagePreview && e.target !== currentImage) {
                        imageInput.click();
                    }
                });
            }
        });
    </script>
{% endblock %}
